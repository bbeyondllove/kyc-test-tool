version: '3.8'

services:
  kyc-api:
    build:
      context: .
      dockerfile: Dockerfile
    image: kyc-test-tool:gpu
    container_name: kyc-api-service
    
    # GPU 支持 (需要 nvidia-docker 或 Docker 19.03+)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    # 环境变量
    environment:
      - NVIDIA_VISIBLE_DEVICES=0
      - CUDA_VISIBLE_DEVICES=0
    
    # 端口映射
    ports:
      - "9000:9000"
    
    # 卷挂载
    volumes:
      # === 开发调试模式：挂载源码（方便实时调试）===
      - ./kyc_full_test.py:/app/kyc_full_test.py:ro
      - ./kyc_api_standalone.py:/app/kyc_api_standalone.py:ro
      - ./liveportrait_server.py:/app/liveportrait_server.py:ro
      # LivePortrait修改后的pipeline文件
      - ./LivePortrait/src/live_portrait_pipeline.py:/app/LivePortrait/src/live_portrait_pipeline.py:ro
      - ./LivePortrait/src/live_portrait_pipeline_animal.py:/app/LivePortrait/src/live_portrait_pipeline_animal.py:ro
      # LivePortrait修改后的配置文件（添加flag_write_concat参数）
      - ./LivePortrait/src/config/argument_config.py:/app/LivePortrait/src/config/argument_config.py:ro
      # 模型权重 (需提前下载或映射到宿主机目录)
      - ./LivePortrait/pretrained_weights:/app/LivePortrait/pretrained_weights:ro
      # 驱动视频示例（只读）
      - ./LivePortrait/assets/examples/driving:/app/LivePortrait/assets/examples/driving:ro
      # LivePortrait缓存目录（可写，用于存储.pkl模板缓存）
      - ./cache/liveportrait:/app/cache/liveportrait
      # 日志持久化
      - ./logs:/app/logs
      # 测试输出
      - ./kyc_test:/app/kyc_test
      # 头像库
      - ./avatars:/app/avatars
    
    # 重启策略
    restart: unless-stopped
    
    # 健康检查
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9000/docs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
